<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <script src="../js/jquery.js"></script>
  <link rel="stylesheet" href="../css/style.css">
  <title>Flight Planner</title>
</head>


<body id="page">
  <button id="theme_switcher">Dark theme</button>
  <div id="header">
    <div id="headerimg">
    </div>
  </div>

  <div class="card">
    <h2><a>Flight Planner</a></h2>

    <br><br>
    <div>
      <button class="square_btn" id="droneConnectButton" style="margin-right:20px">Connect</button>
      <img id="droneConnectImg" src="../images/button.png" height="50" width=50 style="margin-right:20px">
      <h4 id="droneConnectionH4">Push for drone connection</h4>
      <h4 id="droneCoonnectedH4" hidden=true>Drone is connected now!</h4>
    </div>


    <br><br>
    <div id=droneDirectionDiv>
      <button class="square_btn" id="directionDroneButton" style="margin-right:20px" disabled="true">Set
        direction</button>
      <img id="directionDroneImg" src="../images/button.png" height="50" width=50 style="margin-right:20px">
      <h4 id="directionDroneH4">Place the drone facing inspection area</h4>
      <h4 id="directionDroneConnectedH4" hidden=true>Drone is oriented now!</h4>
    </div>
    <br><br>
    <div>
      <h3 style="border: 1.5px solid white;padding: 10px 10px; text-align: center; background-color:#8a1a2d" ;>SELECT
        YOUR FLIGHT PLAN</h3>
      <br>
    </div>
    <div id=droneSettingTabDiv>
      <br>
      <div class="tab">
        <a button class="tablinks" id="RectangleButton" onclick="openTab(event, 'flypathtab')">Rectangle
          mission</button></a>
        <br>
        <a button class="tablinks" id="StraightlineButton" onclick="openTab(event, 'flypathtab')">Straight line
          mission</button></a>
        <br>
        <a button class="tablinks" id="ZigzagButton" onclick="openTab(event, 'flypathtab')">Zig-Zag mission</button></a>
        <br>
        <a button class="tablinks" id="PeriscopeButton" onclick="openTab(event, 'flypathtab')">Periscope
          mission</button></a>

      </div>

      <div id="flypathtab" class="tabcontent" ;>
        <p>
          <div id="rectwidthparameter">
            Rectangle width (d): <input id="rectwidthtext" type="number" value="500"
              onchange="computeMaxDistance()">meters
          </div>
          <br><br>
          <div id="distanceparameter">
            Distance (P): <input id="distancetext" type="number" value=""> meters
          </div>
          <br><br>
          <div id="maxdistanceparameter">
            Maximum distance (Pmax): <label id="maxdistancetext" value="500" onchange="computeMaxDistance()"
              type="number"></label> meters
          </div>


        </p>
      </div>
      <br>
      <div class="otherparameters">
        <h3>
          Select for each mission:
        </h3>
        <br>
        <a button class="tablinks" onclick="openTab(event, 'parameterstab')">Other parameters</button></a>
      </div>
      <div id="parameterstab" class="tabcontent">
        <p>
          Take off distance = <input id="xtext" type="number" value="500" onchange="computeMaxDistance()"> meters
          <br><br>
          Space between lines inside the rectangle = <input id="Ltext" type="number" value="120"
            onchange="computeMaxDistance()"> meters
          <br><br>
          Flight height = <input id="htext" type="number" value="120" onchange="computeMaxDistance()"> meters
        </p>
      </div>
      <div id="LoadMission" ;>
        <h3>
          <br>
          Place the drone pointing towards the wind and push load mission!
          <button class="square_btn" id="uploadbut" disabled="true">Load Mission</button>

          <img id="photoupload" src="../images/button.png" height="30" width=30 style="margin:10px 0px -10px 10px">
        </h3>
      </div>
    </div>
    <br><br>
    <div id=droneStartDiv>
      <button class="square_btn" id="droneStartButton" style="margin-right:20px" disabled="true">Start!</button>
      <img id="photostart" src="../images/button.png" height="50" width=50 style="margin-right:20px">
      <img id="photoplane" src="../images/plane.png" height="50" width=50 style="visibility:hidden; margin-right:20px">
      <h4 id="directionDroneH4">Press start and take off the drone!</h4>
    </div>
  </div>
  <div id="timerDiv">
    <h2>
      <label id="labeltimer"></label>
      <br><br>
      <label id="counthours" type="number"></label>
      <label id="countmins" type="number"></label>
      <label id="count" type="number"></label>
    </h2>
  </div>
  <button class="square_btn" id="timerButton" style="margin-right:20px" onclick="startTimer();">timer!</button>

  <br><br><br>
  <button class="square_btn" id="getresultsbut">
    <a href="../results/History.html">Get results!</a>

  </button>
  </div>
  </div>
  <script>

    var theme = 'DEFAULT'
    openTab({ target: '#Rectanglebutton' }, 'flypathtab');
    computeMaxDistance();

    // var ipConnection = '192.168.0.10';
    var ipConnection = 'localhost';
    var missiontype = 0;

    function openTab(evt, id) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = $('.tablinks')
      console.log()
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      $('#' + id).css('display', 'inline-block');
      $('#droneSettingTabDiv .tablinks').removeClass('active')
      $(evt.target).addClass('active')
    }

    function getParametersTabSize() {
      var $droneSettingsTab = $('#droneSettingTabDiv .tab');
      var height = $droneSettingsTab.height();
      return height;
    }

    getParametersTabSize();
    setParametersTabMinHeight();
    function setParametersTabMinHeight() {
      var $parametersTab = $('#parameterstab');
      $parametersTab.css('min-height', getParametersTabSize());
    }

    var started = false;

    function startTimer() {
      var counter = computeFlightTime();
      if (started == false) {
        started = true;
        setInterval(function () {
          counter--;
          hours = Math.floor(counter / 3600);
          minutes = Math.floor(counter / 60);
          seconds = counter % 60;
          if (counter >= 0) {

            idlabel = document.getElementById("labeltimer");
            idlabel.innerHTML = "Drone landing scheduled in:";
            id = document.getElementById("count");
            id.innerHTML = seconds;
            idmin = document.getElementById("countmins");
            idmin.innerHTML = minutes + ":";
            idhour = document.getElementById("counthours");
            idhour.innerHTML = hours + ":";

          }
          if (counter == 0) {
            idlabel = document.getElementById("labeltimer");
            idlabel.innerHTML = "Drone has landed succesfully";
            started = false;
          }
        }, 1000);
      }
    }

    function computeFlightTime() {

      var distance = parseFloat(document.getElementById("distancetext").value);
      var velocity = 17;
      var velocityConverted = velocity * 3.6;
      var width = parseFloat(document.getElementById("rectwidthtext").value);
      var distance_between_lines = parseFloat(document.getElementById("Ltext").value);
      var time = (width * ((distance / distance_between_lines) + 1) + distance * 2) / velocity;

      return time;

    }


    function computeMaxDistance() {
      var x = document.getElementById("xtext").value;
      var l = document.getElementById("Ltext").value;
      var d = document.getElementById("rectwidthtext").value;
      var nmax = Math.floor((60000 - parseInt(x)) / (2 * parseInt(l) + parseInt(d)));
      var pmax = nmax * l;
      if (pmax <= 0) {
        document.getElementById("maxdistancetext").innerHTML = "0";
      }
      else {
        document.getElementById("maxdistancetext").innerHTML = pmax;
        console.log(nmax);
      }
      return pmax;
    }

    $("#Rectanglebutton").click(function () {
      $("#rectwidthparameter").show();
      $("#distanceparameter").show();
      $("#maxdistanceparameter").show();
      missiontype = 1;
    });


    $("#Straightlinebutton").click(function () {
      $("#distanceparameter").show();
      $("#maxdistanceparameter").show();
      $("#rectwidthparameter").hide();
      missiontype = 2;
    });


    $("#Zigzagbutton").click(function () {
      $("#rectwidthparameter").show();
      $("#distanceparameter").show();
      $("#maxdistanceparameter").show();
      missiontype = 3;
    });

    $("#PeriscopeButton").click(function () {
      $("#rectwidthparameter").show();
      $("#distanceparameter").show();
      $("#maxdistanceparameter").show();
      missiontype = 4;
    });


    $(document).ready(function () {
      $('#theme_switcher').on('click', themeSwitcher);
      $("#droneConnectButton").click(function () {
        document.getElementById('droneConnectImg').src = "../images/waiting.png";
        $.ajax({
          type: 'GET',
          url: 'http://' + ipConnection + ':9000/api/connect',
          dataType: 'json',
          success: function (data, textStatus, xhr) {
            document.getElementById('droneConnectionH4').hidden = true
            document.getElementById('droneCoonnectedH4').hidden = false
            document.getElementById('droneConnectImg').src = "../images/tick.png";
            document.getElementById('directionDroneButton').disabled = false
          },
          error: function (data, textStatus, xhr) {
            document.getElementById('droneConnectImg').src = "../images/cross.png";
            document.getElementById('droneConnectionH4').hidden = true
          },
        })
      });

      $("#directionDroneButton").click(function () {
        document.getElementById('directionDroneImg').src = "../images/waiting.png"
        $.ajax({
          type: 'GET',
          url: 'http://' + ipConnection + ':9000/api/load/directionOfFlight',
          dataType: 'json',
          success: function (data, textStatus, xhr) {
            document.getElementById('directionDroneH4').hidden = true
            document.getElementById('directionDroneConnectedH4').hidden = false
            document.getElementById('directionDroneImg').src = "../images/tick.png";
            document.getElementById('uploadbut').disabled = false;

          },
          error: function (data, textStatus, xhr) {
            document.getElementById('directionDroneImg').src = "../images/cross.png";
            document.getElementById('directionDroneH4').hidden = true
          },
        })
      });

      if (missiontype != 0) {
        console.log(missiontype + "missiontype");
      }
      else {
        console.log(missiontype);
      }


      $("#uploadbut").click(function () {
        document.getElementById('photoupload').src = "../images/waiting.png";
        var p = document.getElementById("distancetext").value;

        if (p != "") {

          var missiontype = missiontypenum;
          var pnum = parseFloat(p);
          var maxdistancetext = $('#maxdistancetext');
          var pmax = parseFloat(maxdistancetext.text());
          var x = parseFloat(document.getElementById("xtext").value);
          var l = parseFloat(document.getElementById("Ltext").value);
          var h = parseFloat(document.getElementById("htext").value);
          var d = parseFloat(document.getElementById("rectwidthtext").value);

          if (pnum < pmax) {
            switch (missiontype) {
              case 1:
                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/rectangleMission/' + pnum + '/' + x + '/' + d + '/' + l + '/' + h,
                    data: { data1: pnum, data2: pmax, data3: x, data4: l, data5: h, data6: d },
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('droneStartButton').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })

              case 2:
                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/straightMission/' + pnum + '/' + h,
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('droneStartButton').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })
              case 3:
                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/zigzagMission/' + pnum + '/' + d + '/' + l + '/' + h,
                    data: { data1: pnum, data2: pmax, data3: x, data4: l, data5: h, data6: d },
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('droneStartButton').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })
              case 4:
                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/zigzagMission/' + pnum + '/' + x + '/' + d + '/' + l + '/' + h,
                    data: { data1: pnum, data2: pmax, data3: x, data4: l, data5: h, data6: d },
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('droneStartButton').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })
            }
          }
        }
      });

      $("#droneStartButton").click(function () {
        document.getElementById('photostart').src = "../images/waiting.png";
        $.ajax
          ({
            type: 'GET',
            url: 'http://' + ipConnection + ':9000/api/start',
            dataType: 'json',
            success: function (data, textStatus, xhr) {
              document.getElementById('photostart').src = "../images/tick.png";
              document.getElementById('photoplane').style = "visibility:visible; margin:10px 0px -10px 10px";
              startTimer();

            },
            error: function (data, textStatus, xhr) {
              document.getElementById('photostart').src = "../images/tick.png";
              document.getElementById('photoplane').style = "visibility:visible; margin:10px 0px -10px 10px";
              startTimer();
            },
          })
      });
    });

    function themeSwitcher() {
      var isDefaultTheme = theme === 'DEFAULT';
      if (isDefaultTheme) {
        theme = 'HIGH_CONTRAST';

        $('body').addClass('HIGH_CONTRAST');
        $('#header').css('background-image', 'none');
        $('#theme_switcher').text('Light theme')
        return;
      }
      if (!isDefaultTheme) {
        theme = 'DEFAULT';

        $('body').removeClass('HIGH_CONTRAST');
        $('#header').css('background-image', 'url("../images/header.png")');
        $('#theme_switcher').text('Dark theme')

        return;
      }
    }
  </script>
</body>

</html>