<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <script src="../js/jquery.js"></script>
  <script src="../js/jquery.MultiLanguage.min.js"></script>
  <link rel="stylesheet" href="../css/style.css">
  <title>Flight Planner</title>
</head>


<body id="page">
  <button id="theme_switcher">Dark theme</button>

  <div id="header">
    <div id="headerimg">


    </div>
  </div>

  <div class="card">
    <h2 id="fp-title"></h2>
    <label id="SD-status"></label>

    <br><br>
    <div>
      <button class="square_btn" id="droneConnectButton" style="margin-right:20px">
        <div id="fp-connect"></div>
      </button>
      <img id="droneConnectImg" src="../images/button.png" height="50" width=50 style="margin-right:20px">
      <h4 id="droneConnectionH4">
        <div id="fp-connect-desc-1"></div>
      </h4>
      <h4 id="droneCoonnectedH4" hidden=true>
        <div id="fp-connect-desc-2"></div>
      </h4>
    </div>


    <br><br>
    <div id=droneDirectionDiv>
      <button class="square_btn" id="directionDroneButton" style="margin-right:20px" disabled="true">
        <div id="fp-setdirection"></div>
      </button>
      <img id="directionDroneImg" src="../images/button.png" height="50" width=50 style="margin-right:20px">
      <h4 id="directionDroneH4">
        <div id="fp-setdirection-desc-1"></div>
      </h4>
      <h4 id="directionDroneConnectedH4" hidden=true>
        <div id="fp-setdirection-desc-2"></div>
      </h4>
    </div>
    <br><br>
    <div>
      <h3 style="border: 1.5px solid white;padding: 10px 10px; text-align: center; background-color:#8a1a2d" ;>
        <div id="fp-selectyourfp"></div>
      </h3>
      <br>
    </div>
    <div id=droneSettingTabDiv>
      <br>
      <div class="tab">
        <a button class="tablinks" id="RectangleButton" onclick="openTab(event, 'flypathtab')"
          onclick="computeMaxDistance()">
          <div id="fp-rectangle"></div></button>
        </a>
        <br>
        <a button class="tablinks" id="StraightlineButton" onclick="openTab(event, 'flypathtab')"
          onclick="computeMaxDistance()">
          <div id="fp-straight"></div></button>
        </a>
        <br>
        <a button class="tablinks" id="ZigzagButton" onclick="openTab(event, 'flypathtab')"
          onclick="computeMaxDistance()">
          <div id="fp-zigzag"></div></button>
        </a>
        <br>
        <a button class="tablinks" id="PeriscopeButton" onclick="openTab(event, 'flypathtab')"
          onclick="computeMaxDistance()">
          <div id="fp-periscope"></div></button>
        </a>
        <br>

      </div>

      <div id="flypathtab" class="tabcontent" ;>
        <p>
        <div id="rectwidthparameter">
          <p id="fp-rect"></p><input id="rectwidthtext" type="number" value="500" onchange="computeMaxDistance()">
        </div>
        <br>
        <div id="zigwidthparameter">
          <p id="fp-zigwidthparameter"></p><input id="rectwidthtextZigZag" type="number" value="500"
            onchange="computeMaxDistanceZigZag()">meters
        </div>
        <br>
        <div id="inversedParameter">
          <p id="fp-inversed"></p> <select onchange="inversedSelector();" onchange="computeMaxDistance()" id="inversed">
            <option value="1">Yes</option>
            <option value="2" selected>No</option>
          </select>
          <p id="fp-inversed-desc"></p>

        </div>
        <br>
        <div id="distanceparameter">
          <p id="fp-distanceparameter"></p><input id="distancetext" type="number" value=""
            onchange="computeMaxDistance()"> meters
        </div>

        <br>
        <div id="maxdistanceparameter">
          <p id="fp-maxdistanceparameter"></p><label id="maxdistancetext" value="500" onchange="computeMaxDistance()"
            type="number"></label> meters
        </div>
        <br>
        <div id="distanceStraightParameter">
          <p id="fp-maxdistanceStraightparameter"></p><label id="maxdistanceStraightText" value="30000"
            type="number">Maximum
            distance: 30000 meters</label>
        </div>
        <br>
        <div id="periscope">
          <p id="fp-periscope-desc">
        </div>
        <br>
        <div id="rectangleImage">
          <img src="../images/rectangleImage.png" height="500" width="350" style="margin-right:20px">
        </div>
        <br>
        <div id="straightImage">
          <img src="../images/straightImage.png" height="500" width="250" style="margin-right:20px">
        </div>
        <br>
        <div id="zigzagImage">
          <img src="../images/zigzagImage.png" height="500" width="350" style="margin-right:20px">
        </div>
        <br>
        <div id="periscopeImage">
          <img src="../images/periscopeImage.png" height="400" width="350" style="margin-right:20px">
        </div>

      </div>


      </p>
    </div>
    <br>
    <div class="otherparameters">
      <h3 id="fp-selectforeachmission">
      </h3>
      <br>
      <a button class="tablinks" onclick="openTab(event, 'parameterstab')">
        <div id="fp-otherparameters"></div></button>
      </a>
    </div>
    <div id="parameterstab" class="tabcontent">
      <p>
        Take off distance = <input id="xtext" type="number" value="500" onchange="computeMaxDistance()"> meters
        <br><br>
        Space between lines or between peaks in zig zag = <input id="Ltext" type="number" value="120"
          onchange="computeMaxDistance()"> meters
        <br><br>
        Flight height = <input id="htext" type="number" value="120" onchange="computeMaxDistance()"> meters
      </p>
    </div>
    <div id="LoadMission" ;>
      <h3>
        <br><br>
        <div id="fp-loadmission-desc"></div>
        <br>
        <button class="square_btn" id="uploadbut" disabled="true">
          <div id="fp-loadmission"></div>
        </button>

        <img id="photoupload" src="../images/button.png" height="30" width=30 style="margin:10px 0px -10px 10px">
      </h3>
    </div>
    <div id="Calibration" ;>
      <h3>
        <div id="fp-calibration-desc"></div>
        <br>
        <button class="square_btn" id="calibrationbut" disabled="true">
          <div id="fp-calibration"></div>
        </button>

        <img id="photoCalibration" src="../images/button.png" height="30" width=30 style="margin:10px 0px -10px 10px">
      </h3>
    </div>
  </div>
  <br><br>
  <div id=droneStartDiv>
    <button class="square_btn" id="droneStartButton" style="margin-right:20px" disabled="true">
      <div id="fp-start"></div>
    </button>
    <img id="photostart" src="../images/button.png" height="50" width=50 style="margin-right:20px">
    <img id="photoplane" src="../images/plane.png" height="50" width=50 style="visibility:hidden; margin-right:20px">
    <h4 id="directionDroneH4">
      <div id="fp-start-desc"></div>
    </h4>
  </div>
  <div id="timerDiv">
    <h2>
      <label id="labeltimer"></label>
      <br><br>
      <label id="counthours" type="number"></label>
      <label id="countmins" type="number"></label>
      <label id="count" type="number"></label>
    </h2>
  </div>

  <br>
  <button class="square_btn" id="restartButton" onclick="window.location='/Planner'">
    <div id="fp-restart"></div>
  </button>
  <button class="square_btn" id="getresultsbut">
    <a href="../results/History.html">
      <div id="fp-getresults"></div>
    </a>

  </button>


  <br>


  <select onchange="languageSelector();" id="languageSelector" class="language">
    <option value="en">English</option>
    <option value="ar">عرب</option>
  </select>


  <script>

    var theme = 'DEFAULT'
    openTab({ target: '#Rectanglebutton' }, 'flypathtab');
    computeMaxDistance();

    var ipConnection = 'localhost';
    var missiontype = 0;
    var inversed;


    function openTab(evt, id) {

      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";

      }
      tablinks = $('.tablinks')
      console.log()
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
        computeMaxDistance()

      }

      $('#' + id).css('display', 'inline-block');
      $('#droneSettingTabDiv .tablinks').removeClass('active')
      $(evt.target).addClass('active')
    }

    function getParametersTabSize() {
      var $droneSettingsTab = $('#droneSettingTabDiv .tab');
      var height = $droneSettingsTab.height();
      return height;
    }

    getParametersTabSize();
    setParametersTabMinHeight();
    function setParametersTabMinHeight() {
      var $parametersTab = $('#parameterstab');
      $parametersTab.css('min-height', getParametersTabSize());
    }

    var started = false;

    function startTimer() {
      var counter = computeFlightTime();
      if (started == false) {
        started = true;
        setInterval(function () {
          counter--;
          console.log("counter", counter)
          hours = Math.floor(counter / 3600);
          minutes = Math.floor((counter / 60) % 60);
          seconds = counter % 60;

          if (counter >= 0) {

            idlabel = document.getElementById("labeltimer");
            idlabel.innerHTML = "Drone landing scheduled in:";
            id = document.getElementById("count");
            id.innerHTML = seconds;
            idmin = document.getElementById("countmins");
            idmin.innerHTML = minutes + ":";
            idhour = document.getElementById("counthours");
            idhour.innerHTML = hours + ":";

          }
          if (counter == 0) {
            idlabel = document.getElementById("labeltimer");
            idlabel.innerHTML = "Drone has landed succesfully";
            started = false;
          }
        }, 1000);
      }
    }

    function inversedSelector() {

      inversed = parseInt(document.getElementById("inversed").value)
      console.log(inversed)

    }

    function calcHypot(a, b) {
      return Math.sqrt(Math.pow(a, 2) + Math.pow(b, 2))
    }

    function computeFlightTime() {

      var time = null
      var distance = parseFloat(document.getElementById("distancetext").value);
      var velocity = 17;
      var width = parseFloat(document.getElementById("rectwidthtext").value);
      var zigzagWidth = parseFloat(document.getElementById("rectwidthtextZigZag").value);
      var distanceBetweenLines = parseFloat(document.getElementById("Ltext").value);
      var takeOffDistance = parseFloat(document.getElementById("xtext").value);
      var hypot = calcHypot(takeOffDistance, width / 2)
      var hZigZag = calcHypot(width, distanceBetweenLines)

      if (missiontype == 1) {
        var path = ((distance / distanceBetweenLines) * (distanceBetweenLines + width)) + hypot + takeOffDistance + distance
        time = path / velocity;

        console.log("patrh", path)
        console.log("time", time)
        console.log("rectangle done")


      } else if (missiontype == 2) {
        var path = (distance + takeOffDistance) * 2
        time = path / velocity;

        console.log("patrh", path)
        console.log("time", time)

        console.log("straight done")


      } else if (missiontype == 3) {

        var path = ((distance / distanceBetweenLines) * hZigZag) + distance + takeOffDistance + hypot
        time = path / velocity;

      } else {

        var radius = 100

        var perimeter = Math.PI * radius * 2

        var path = (radius * 2) + (2 * perimeter)

        time = path / velocity;

        console.log("periscope")

      }

      console.log(Math.round(time + (7 * 60)))

      return Math.round(time + (7 * 60));


    }


    function computeMaxDistance() {
      var x = document.getElementById("xtext").value;
      var l = document.getElementById("Ltext").value;
      var d = document.getElementById("rectwidthtext").value;
      var nmax = Math.floor((60000 - parseInt(x)) / (2 * parseInt(l) + parseInt(d)));
      var pmax = nmax * l;
      if (pmax <= 0) {
        document.getElementById("maxdistancetext").innerHTML = "0";
      }
      else {
        document.getElementById("maxdistancetext").innerHTML = pmax;
      }

    }

    function computeMaxDistanceZigZag() {
      console.log("hola")
      var x = document.getElementById("xtext").value;
      var l = document.getElementById("Ltext").value;
      var d = document.getElementById("rectwidthtextZigZag").value;
      var nmax = Math.floor((60000 - parseInt(x)) / (2 * parseInt(l) + parseInt(d)));
      var pmax = nmax * l;
      if (pmax <= 0) {
        document.getElementById("maxdistancetext").innerHTML = "0";
      }
      else {
        document.getElementById("maxdistancetext").innerHTML = pmax;
        console.log(nmax);
      }

    }



    function languageSelector() {

      var x = document.getElementById("languageSelector").value;
      console.log(x)
      $.MultiLanguage('/language.json', x)


    }

    function round(value, decimals) {
      return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }


    function diskSpace() {

      $.ajax({
        type: 'GET',
        url: 'http://' + ipConnection + ':9000/api/utilities/SDdiskSpace',
        dataType: 'json',
        success: function (data, textStatus, xhr) {
          $("#SD-status").empty();
          $("#SD-status").append(round((data.sizeSpace - data.freeSpace),2) + " GB / " + data.sizeSpace + " GB")
        },
        error: function (data, textStatus, xhr) {
          document.getElementById('droneConnectImg').src = "../images/cross.png";
          document.getElementById('droneConnectionH4').hidden = true
        },
      })

    }

    $("#RectangleButton").click(function () {
      $("#rectwidthparameter").show();
      $("#inversedParameter").show();
      $("#zigwidthparameter").hide();
      $("#distanceparameter").show();
      $("#maxdistanceparameter").show();
      $("#periscope").hide();
      $("#heightParam").hide();
      $("#distanceStraightParameter").hide();
      $("#rectangleImage").show();
      $("#straightImage").hide();
      $("#zigzagImage").hide();
      $("#periscopeImage").hide();

      inversed = 2;
      missiontype = 1;
    });


    $("#StraightlineButton").click(function () {
      $("#distanceparameter").show();

      $("#distanceStraightParameter").show();
      $("#maxdistanceparameter").hide();
      $("#rectwidthparameter").hide();
      $("#zigwidthparameter").hide();
      $("#periscope").hide();
      $("#heightParam").hide();
      $("#inversedParameter").hide();
      $("#rectangleImage").hide();
      $("#straightImage").show();
      $("#zigzagImage").hide();
      $("#periscopeImage").hide();



      missiontype = 2;
    });


    $("#ZigzagButton").click(function () {
      $("#zigwidthparameter").show();
      $("#inversedParameter").show();
      $("#distanceparameter").show();
      $("#maxdistanceparameter").show();
      $("#rectwidthparameter").hide();
      $("#periscope").hide();
      $("#heightParam").hide();
      $("#distanceStraightParameter").hide();
      $("#rectangleImage").hide();
      $("#straightImage").hide();
      $("#zigzagImage").show();
      $("#periscopeImage").hide();

      inversed = 2;
      missiontype = 3;
    });

    $("#PeriscopeButton").click(function () {
      $("#rectwidthparameter").hide();
      $("#periscope").show();
      $("#zigwidthparameter").hide();
      $("#distanceparameter").hide();
      $("#maxdistanceparameter").hide();

      $("#inversedParameter").hide();
      $("#distanceStraightParameter").hide();
      $("#rectangleImage").hide();
      $("#straightImage").hide();
      $("#zigzagImage").hide();
      $("#periscopeImage").show();

      missiontype = 4;
    });


    $(document).ready(function () {

      $.MultiLanguage('/language.json', 'en')

      diskSpace()
      $('#theme_switcher').on('click', themeSwitcher);
      $("#droneConnectButton").click(function () {
        document.getElementById('droneConnectImg').src = "../images/waiting.png";
        $.ajax({
          type: 'GET',
          url: 'http://' + ipConnection + ':9000/api/connect',
          dataType: 'json',
          success: function (data, textStatus, xhr) {
            document.getElementById('droneConnectionH4').hidden = true
            document.getElementById('droneCoonnectedH4').hidden = false
            document.getElementById('droneConnectImg').src = "../images/tick.png";
            document.getElementById('directionDroneButton').disabled = false
          },
          error: function (data, textStatus, xhr) {
            document.getElementById('droneConnectImg').src = "../images/cross.png";
            document.getElementById('droneConnectionH4').hidden = true
          },
        })
      });

      // $("#languageSelector").on('click', languageSelector);

      $("#directionDroneButton").click(function () {
        document.getElementById('directionDroneImg').src = "../images/waiting.png"
        $.ajax({
          type: 'GET',
          url: 'http://' + ipConnection + ':9000/api/load/directionOfFlight',
          dataType: 'json',
          success: function (data, textStatus, xhr) {
            document.getElementById('directionDroneH4').hidden = true
            document.getElementById('directionDroneConnectedH4').hidden = false
            document.getElementById('directionDroneImg').src = "../images/tick.png";
            document.getElementById('uploadbut').disabled = false;

          },
          error: function (data, textStatus, xhr) {
            document.getElementById('directionDroneImg').src = "../images/cross.png";
            document.getElementById('directionDroneH4').hidden = true
          },
        })
      });

      $("#uploadbut").click(function () {
        var distanceText = document.getElementById("distancetext").value;

        if (distanceText != "" || missiontype == 4) {


          var distance = parseFloat(distanceText);
          var maxDistance = parseFloat($('#maxdistancetext').text());
          var maxDistanceStraight = 30000
          var takeoffSDistance = parseFloat(document.getElementById("xtext").value);
          var spaceBetweenLines = parseFloat(document.getElementById("Ltext").value);
          var height = parseFloat(document.getElementById("htext").value);
          var width = parseFloat(document.getElementById("rectwidthtext").value);
          var zigzagWidth = parseFloat(document.getElementById("rectwidthtextZigZag").value);



          console.log(inversed)

          if (missiontype != 2 && distance <= maxDistance) {
            document.getElementById('photoupload').src = "../images/waiting.png";


            switch (missiontype) {
              case 1:
                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/rectangleMission/' + distance + '/' + width + '/' + spaceBetweenLines + '/' + takeoffSDistance + '/' + height + '/' + inversed,
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('calibrationbut').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })
                break;

              case 3:
                console.log("3")

                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/ZigZagMission/' + distance + '/' + zigzagWidth + '/' + spaceBetweenLines + '/' + takeoffSDistance + '/' + height + '/' + inversed,
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('calibrationbut').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })
                break;
              case 4:
                console.log("4")
                $.ajax
                  ({
                    type: 'POST',
                    url: 'http://' + ipConnection + ':9000/api/load/periscopeMission/' + height,
                    dataType: 'json',
                    success: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/tick.png";
                      document.getElementById('calibrationbut').disabled = false;

                    },
                    error: function (data, textStatus, xhr) {
                      document.getElementById('photoupload').src = "../images/cross.png";
                    },
                  })
                break;
            }
          } else if (missiontype == 2 && distance <= maxDistanceStraight) {
            document.getElementById('photoupload').src = "../images/waiting.png";

            $.ajax
              ({
                type: 'POST',
                url: 'http://' + ipConnection + ':9000/api/load/straightMission/' + distance + '/' + takeoffSDistance + '/' + height,
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                  document.getElementById('photoupload').src = "../images/tick.png";
                  document.getElementById('calibrationbut').disabled = false;

                },
                error: function (data, textStatus, xhr) {
                  document.getElementById('photoupload').src = "../images/cross.png";
                },
              })


          } else if (missiontype == 4) {
            document.getElementById('photoupload').src = "../images/waiting.png";

            $.ajax
              ({
                type: 'POST',
                url: 'http://' + ipConnection + ':9000/api/load/periscopeMission/' + height,
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                  document.getElementById('photoupload').src = "../images/tick.png";
                  document.getElementById('calibrationbut').disabled = false;

                },
                error: function (data, textStatus, xhr) {
                  document.getElementById('photoupload').src = "../images/cross.png";
                },
              })


          } else {
            console.log("the distance of flight is lower than the maximum permited")
            console.log(distance)
            console.log(maxDistanceStraight)
          }
        }
      });

      $("#calibrationbut").click(function () {
        document.getElementById('photoCalibration').src = "../images/waiting.png";
        $.ajax
          ({
            type: 'GET',
            url: 'http://' + ipConnection + ':9000/api/start/calibration',
            dataType: 'json',
            success: function (data, textStatus, xhr) {
              document.getElementById('photoCalibration').src = "../images/tick.png";
              document.getElementById('droneStartButton').disabled = false;

            },
            error: function (data, textStatus, xhr) {
              document.getElementById('photoCalibration').src = "../images/cross.png";
              document.getElementById('droneStartButton').disabled = false;

            },
          })
      });

      $("#droneStartButton").click(function () {
        document.getElementById('photostart').src = "../images/waiting.png";
        $.ajax
          ({
            type: 'GET',
            url: 'http://' + ipConnection + ':9000/api/start/arm',
            dataType: 'json',
            success: function (data, textStatus, xhr) {
              document.getElementById('photostart').src = "../images/tick.png";
              document.getElementById('photoplane').style = "visibility:visible; margin:10px 0px -10px 10px";
              startTimer()
              $.ajax
                ({
                  type: 'GET',
                  url: 'http://' + ipConnection + ':9000/api/start',
                  dataType: 'json',
                  success: function (data, textStatus, xhr) {
                    console.log("START OK")
                  },
                  error: function (data, textStatus, xhr) {
                    console.log("START KO?")
                  },
                })
            },
            error: function (data, textStatus, xhr) {
              document.getElementById('photostart').src = "../images/cross.png";

            },
          })
      });

    });

    function themeSwitcher() {
      var isDefaultTheme = theme === 'DEFAULT';
      if (isDefaultTheme) {
        theme = 'HIGH_CONTRAST';

        $('body').addClass('HIGH_CONTRAST');
        // $('#header').css('background-image', 'none');
        $('#theme_switcher').text('Light theme')
        return;
      }
      if (!isDefaultTheme) {
        theme = 'DEFAULT';

        $('body').removeClass('HIGH_CONTRAST');
        //$('#header').css('background-image', 'url("../images/header.png")');
        $('#theme_switcher').text('Dark theme')

        return;
      }
    }
  </script>
</body>

</html>