<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../css/style.css">
    <title>Flight Planner</title>
</head>


<body id="page">
    <div id="header">
        <div id="headerimg">
        </div>
    </div>

    <script src="/jquery.js"></script>
    <!-- <script src="GetResults.js"></script>
  <script src="ThisResult.js"></script> -->
    <button id="theme_switcher">Dark theme</button>
    <h2><a>Locust Finder</a></h2>
    <br><br>
    <hr />
    <div id="viewPhoto" class="viewPhoto">
        <img id = "image" src="/results/photos/Test Flight/1.jpeg" height="398" width="776">
    </div>
    <div id="VideoController" class="VideoController">
        <div id="InsideVideoController" class="InsideVideoController">
            <div id="ButtonMinorLeft" class="ButtonMinorLeft">
                <button id="ButtonMinorLeft" class="MinorButton" target="_new"><</button>
            </div>
            <div id="ButtonMajorLeft" class="ButtonMajorLeft">
                <button id="ButtonMajorLeft" class="square_btn" target="_new"><<</button>
            </div>
            <div id="ButtonMajorRight" class="ButtonMajorRight">
                <button id="ButtonMajorRight" class="square_btn"  target="_new">>></button>
            </div>
            <div id="ButtonMinorRight" class="ButtonMinorRight">
                <button id="ButtonMinorRight" class="MinorButton" target="_new">></button>
            </div>
        </div>

    </div>
    <script>
        $(document).ready(function () {
            var theme = 'DEFAULT'
            var index = 0;
            var indexBefore = 0;
            var freq = 1 / 8;
            var ipConnection = 'localhost'
            var videoJSON = getJSON(ipConnection);
            videoJSON.then(data => {
                console.log(data[0].results.length)

            })


            fillHistoryTable(ipConnection);
            $('#theme_switcher').on('click', themeSwitcher);

            $('#ButtonMajorRight').click(function () {
                var videoJSON = getJSON(ipConnection);

                videoJSON.then(data => {

                    numPhotos = Math.floor(Math.floor(data[0].results.length) * freq);

                    var pointer = Math.floor(data[0].results.length / numPhotos);

                    var position;

                    //tener en cuenta los que tienen resto igual a 0 ya que habr√≠a que sumarles uno

                    if (index <= (data[0].results.length) - (pointer)) {

                        if (index != 0) {
                            if (index == indexBefore) {
                                position = indexBefore + pointer;

                                if (position >= (data[0].results.length)) {
                                    position = (data[0].results.length) - 1
                                }

                                $('#image').prop('src', data[0].results[position].image_path);
                                index = position;
                                indexBefore = position;
                                console.log(position + "uno")
                            }
                            else {
                                console.log(index)
                                position = (Math.ceil(index * freq) * pointer) + 1
                                console.log(position)
                                $('#image').prop('src', data[0].results[position].image_path);
                                index = position;
                                indexBefore = position;
                                console.log(position + "dos")
                            }


                        } else {
                            position = pointer + 1;
                            $('#image').prop('src', data[0].results[position].image_path);
                            index = position;
                            indexBefore = position;
                            console.log(position + "tres")

                        }
                    } else {

                        position = (data[0].results.length) - 1

                        $('#image').prop('src', data[0].results[position].image_path);
                        console.log((data[0].results.length) - 1 + "cuatro")

                        index = position;
                        indexBefore = position;

                    }

                })
            });

            $('#ButtonMinorRight').click(function () {
                var videoJSON = getJSON(ipConnection);

                videoJSON.then(data => {

                    numPhotos = Math.floor(Math.floor(data[0].results.length) * freq);

                    var pointer = Math.floor(data[0].results.length / numPhotos);

                    var position = index + 1

                    if ((position - 1) % pointer == 0) {
                        indexBefore = position;
                        console.log("OK")
                    }

                    if (position <= (data[0].results.length) - 1) {
                        $('#image').prop('src', data[0].results[position].image_path);
                        index = position;
                        console.log(position + " " + index + "cinco")

                    } else {
                        console.log("SE ACABO POR ARRIBA")
                        index = (data[0].results.length) - 1

                    }
                })

            });

            $('#ButtonMajorLeft').click(function () {
                var videoJSON = getJSON(ipConnection);

                videoJSON.then(data => {

                    numPhotos = Math.floor(Math.floor(data[0].results.length) * freq);

                    var pointer = Math.floor(data[0].results.length / numPhotos);

                    var position;


                    if (index >= 0 && index != (data[0].results.length) - 1) {

                        if (index != 0) {
                            if (index == indexBefore) {
                                position = indexBefore - pointer;
                                $('#image').prop('src', data[0].results[position].image_path);
                                index = position;
                                indexBefore = position;
                                console.log(position + "seis")
                            }
                            else {
                                console.log(index)
                                position = (Math.floor(index * freq) * pointer) + 1
                                console.log(position)
                                $('#image').prop('src', data[0].results[position].image_path);
                                index = position;
                                indexBefore = position;
                                console.log(position + "siete")
                            }


                        } else {
                            position = pointer + 1;
                            $('#image').prop('src', data[0].results[position].image_path);
                            index = position;
                            indexBefore = position;
                            console.log(position + "ocho")

                        }
                    } else if (index == (data[0].results.length) - 1) {

                        position = (pointer * (numPhotos)) + 1



                        $('#image').prop('src', data[0].results[position].image_path);
                        console.log(position + "nueve")

                        index = position;
                        indexBefore = position;

                    }

                })

            });

            $('#ButtonMinorLeft').click(function () {
                var videoJSON = getJSON(ipConnection);

                videoJSON.then(data => {

                    numPhotos = Math.floor(Math.floor(data[0].results.length) * freq);

                    var pointer = Math.floor(data[0].results.length / numPhotos);

                    var position = index - 1

                    if ((position - 1) % pointer == 0) {
                        indexBefore = position;
                        console.log("OK")
                    }

                    if (position >= 0) {
                        $('#image').prop('src', data[0].results[position].image_path);
                        index = position;
                        console.log(position + " " + index + "diez")

                    } else {
                        console.log("SE ACABO POR ABAJO")
                        index = 0

                    }
                })

            });


        })



        async function getJSON(ipConnection) {

            await $.ajax({
                type: 'GET',
                url: 'http://' + ipConnection + ':9000/videoResults.json',
                dataType: 'json',
                success: function (json) {
                    result = json;
                }
            })

            return result

        }

        function test(index) {

            console.log(index)

        }




        function fillHistoryTable(ipConnection) {
            $("#historyTable").html(""); //primero vacio la tabla existente

            $.ajax({
                type: 'GET',
                url: 'http://' + ipConnection + ':9000/results.json',
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (index, datos) {
                        $("#historyTable").append("<tr><td>" + datos.id + "</td><td><button id='" + index + "' type='button' class='square_btn' onclick='fillResultsTable(" + index + ")'>GO!</button></td></tr>");
                    });
                }
            })

        }

        function fillResultsTable(passId) {
            $("#resultsTable").html(""); //primero vacio la tabla existente

            var ipConnection = 'localhost'

            $.ajax({
                type: 'GET',
                url: 'http://' + ipConnection + ':9000/results.json',
                dataType: 'json',
                success: function (data) {
                    $.each(data[passId].results, function (index, datos) {
                        console.log(datos);
                        $("#resultsTable").append("<tr><td>" + datos.image_id + "</td><td>" + datos.percentage + "</td><td>" + datos.coordinates[0] + "</td><td>" + datos.coordinates[1] + "</td><td><a href=" + datos.image_path + ">Show image</a></td></tr>");
                    });
                }
            })


        }

        function themeSwitcher() {
            var isDefaultTheme = theme === 'DEFAULT';
            if (isDefaultTheme) {
                theme = 'HIGH_CONTRAST';

                $('body').addClass('HIGH_CONTRAST');
                $('#header').css('background-image', 'none');
                $('#theme_switcher').text('Light theme')
                return;
            }
            if (!isDefaultTheme) {
                theme = 'DEFAULT';

                $('body').removeClass('HIGH_CONTRAST');
                $('#header').css('background-image', 'url("../images/FundationHemavLogo.png")');
                $('#theme_switcher').text('Dark theme')

                return;
            }
        }

    </script>

</body>

</html>